# Oneshot AI Anomaly Detection 用 Docker Compose設定
#
# 使用方法（起動スクリプト推奨）:
#   ./start.sh
#
# 手動で起動する場合:
#   xhost +local:docker
#   LOCAL_UID=$(id -u) LOCAL_GID=$(id -g) docker compose run --rm anomaly-detection

services:
  anomaly-detection:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: oneshot-ai-anomaly:latest
    container_name: oneshot-ai-anomaly
    privileged: true
    network_mode: host

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - LOCAL_UID=${LOCAL_UID}
      - LOCAL_GID=${LOCAL_GID}
      - LOCAL_USER=${USER}
      - PULSE_SERVER=unix:${XDG_RUNTIME_DIR}/pulse/native
      # HuggingFaceキャッシュパス（コンテナ内のユーザーに依存しない固定パス）
      - HF_HOME=/hf_cache

    volumes:
      # X11ソケット（GUI表示用）
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # アプリケーションコード（ホストマシンのコードをマウント）
      - .:/app
      # デバイスアクセス（カメラ用）
      - /dev:/dev
      # PulseAudio（ブザー音再生用）
      - ${XDG_RUNTIME_DIR}/pulse/native:${XDG_RUNTIME_DIR}/pulse/native
      # HuggingFaceキャッシュ（認証トークン・モデルキャッシュの永続化）
      - ~/.cache/huggingface:/hf_cache

    working_dir: /app

    # main.py（検査GUIアプリ）を起動
    # bashで起動したい場合は下記に変更: command: /bin/bash
    command: python main.py

    # TTY設定（GUI表示に必要）
    stdin_open: true
    tty: true
