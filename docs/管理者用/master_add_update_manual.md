# マスター追加・更新マニュアル

## 概要

このマニュアルでは、検査アプリケーションにおいてマスターを追加・更新する手順について説明します。


## 前提

**マスターの追加・更新作業を実施する場合は、検査アプリを一度シャットダウンしてから実施してください。**


## 1. マスター追加（新品種の検査を行う場合）

### ステップ1: マスターを格納するためのフォルダを作成
このステップでは、新品種のマスター画像、その他検査に必要なファイルを格納するためのフォルダを指定の位置に作成します。

1. デスクトップの"Kagome-Inspection-App"を開く。
   <img src="picture/014.png" width="500">

2. "master"フォルダを開く。
   <img src="picture/015.png" width="500">

3. "master"フォルダに入った状態で、右クリックを押し、"新しいフォルダ"を選択し、品種名のフォルダを作成する。
   - 今回は一例として、"サンプル"フォルダを作成。
   - 新しい品種は"master"フォルダの下に作らないと、検査アプリがマスターとして認識してくれないので注意。
   <img src="picture/016.png" width="500">

   
### ステップ2: マスター画像の候補画像を撮影
このステップでは、新品種のマスター画像の候補となる画像を撮影します。検査対象の品種が生産されているタイミングで実施してください。

1. デスクトップの"画像撮影アプリ"を開く。
   <img src="picture/017.png" width="500">

2. "撮影枚数"を指定する。
   - 推奨は200~500枚程度。
   <img src="picture/018.png" width="500">

3. 画像を保存する"保存先ディレクトリ"を参照ボタンから選択する。
   - 直接アドレスを記述することも可能。
   - "保存先ディレクトリ"は、ステップ1で作成したフォルダを指定するのがおすすめ。
   - ステップ1で例として作成した"サンプル"フォルダのアドレスは、"/home/user/codes/Kagome-Inspection-App/master/サンプル"。

   <img src="picture/019.png" width="500">

   <img src="picture/020.png" width="500">

4. "カメラ設定ファイル"は基本的に変更しない。
   <img src="picture/021.png" width="500">

5. 新品種のフィルム充填機が稼働していることを確認して、撮影開始ボタンを押す。
   - カメラパラメータの読み込みなどに時間がかかるので、撮影完了までに30秒程度時間がかかりますので、しばらく待ってください。
   - 撮影が完了すれば、進捗のステータスバーが100%となり、撮影完了の通知が出ます。
      <img src="picture/022.png" width="500">

   - "保存先ディレクトリ"に画像が保存されていることが確認できればOK。
      <img src="picture/023.png" width="500">

6. "終了"ボタンを押して、アプリを終了する。
   <img src="picture/031.png" width="500">

### ステップ3: マスター画像を選択する
このステップでは、ステップ2で"保存先ディレクトリ"の中に生成された画像のなかから、新品種のマスター画像を1枚選択します。

1. デスクトップの"Kagome-Inspection-App"を開く。
   <img src="picture/014.png" width="500">

2. "master"フォルダを開く。
   <img src="picture/015.png" width="500">

3. 新品種のフォルダを選択し、画像を確認する。

   <img src="picture/026.png" width="500">

4. ブレがなく、品種のマークなどが鮮明に写った画像をマスター画像として選択し、"master.bmp"という名前に変更する。
   - マスター画像とする画像を選択した上で右クリックし、"名前を変更"をクリックしてファイル名を"master.bmp"に変更する。

   <img src="picture/024.png" width="500">

5. それ以外の画像は削除する。
   - 削除しなくても問題ないですが、PCのストレージが圧迫されるため、不要な画像の削除をおすすめします。



### ステップ4: 選択したマスター画像をもとに検査に必要なファイルを生成
このステップでは、ステップ3で作成したマスター画像をもとに、検査に必要なファイル（master.npy/master_hue.txt）を生成します。

1. デスクトップの"マスター特徴量生成アプリ"を開く。
   <img src="picture/027.png" width="500">

2. 新品種を選択して"特徴量生成開始"をクリック。（今回の例では"サンプル"を選択。）
   <img src="picture/028.png" width="500">

3. "サンプル"フォルダに、マスター画像(master.bmp)をベースとしたmaster.npyとmaster_hue.txtが生成される。
   <img src="picture/029.png" width="500">

4. 処理完了通知を"OK"を押して閉じ、"終了"ボタンを押してアプリを終了する。
   <img src="picture/030.png" width="500">


### ステップ5: 検査アプリで新品種が検査できることを確認＆閾値設定
ステップ4までで、新品種の検査に必要な材料はすべて揃っている状態になっています。このステップでは、実際に検査アプリを起動して、新品種の検査を行ってみましょう。

1. デスクトップの"Kagome検査アプリ"を開く。
   <img src="picture/032.png" width="500">

2. これまでのステップで作成した新品種が検査品種として選択可能であることを確認する。
   <img src="picture/033.png" width="500">

3. "パラメータ設定"ボタンを押して、新品種の閾値を調整する。
   - 初期の閾値として、ベース（デフォルト）閾値と同じ値が設定されます。
   - 実際に検査を行いながら、閾値を調整してください。
   <img src="picture/034.png" width="500">



## 2. マスター更新（既存品種のマスターを変更する場合）

### ステップ1: マスターの各ファイルの名前を変更する
以降は、マスター追加手順と同じような手順でマスターファイルを生成していきます。新品種のマスターを追加する手順と同様の手順を踏むと、既存のマスターファイルがすべて上書きされてしまいます。もし既存のファイルを上書きせずに残しておきたい場合は、下記のように３つのファイルのファイル名を変更しておいてください。

（下記の例では、NKRのマスターを更新する場合を仮定して、各マスターファイルの名前の後ろに作業日を追加しています。）

   <img src="picture/041.png" width="500">


### ステップ2: マスター画像の候補画像を撮影
このステップは、マスター追加のステップ2と基本的に同様の手順です。"画像撮影アプリ"を開き、更新したい製品のマスターファイルが保存されているフォルダを"保存先ディレクトリ"として指定し、マスター画像の候補となる画像を撮影します。

1. デスクトップの"画像撮影アプリ"を開く。
   <img src="picture/017.png" width="500">

2. "撮影枚数"を指定する。
   - 推奨は200~500枚程度。
   <img src="picture/018.png" width="500">

3. 画像を保存する"保存先ディレクトリ"を参照ボタンから選択する。
   - 下記の例では、NKRのマスターを更新している。

   <img src="picture/019.png" width="500">

   <img src="picture/035.png" width="500">

4. "カメラ設定ファイル"は基本的に変更しない。
   <img src="picture/021.png" width="500">

5. 対象品種のフィルム充填機が稼働していることを確認して、撮影開始ボタンを押す。
   - カメラパラメータの読み込みなどに時間がかかるので、撮影完了までに30秒程度時間がかかりますので、しばらく待ってください。
   - 撮影が完了すれば、進捗のステータスバーが100%となり、撮影完了の通知が出ます。
      <img src="picture/022.png" width="500">

   - "保存先ディレクトリ"に画像が保存されていることが確認できればOK。
      <img src="picture/023.png" width="500">

6. "終了"ボタンを押して、アプリを終了する。
   <img src="picture/031.png" width="500">


### ステップ3: マスター画像を選択する
このステップは、マスター追加のステップ3と基本的に同様の手順です。ステップ2で"保存先ディレクトリ"の中に生成された画像のなかから、更新する品種のマスター画像を1枚選択します。

1. デスクトップの"Kagome-Inspection-App"を開く。
   <img src="picture/014.png" width="500">

2. "master"フォルダを開く。
   <img src="picture/015.png" width="500">

3. 更新したい品種のフォルダを選択し、画像を確認する。

   <img src="picture/043.png" width="500">

4. ブレがなく、品種のマークなどが鮮明に写った画像をマスター画像として選択し、"master.bmp"という名前に変更する。
   - マスター画像とする画像を選択した上で右クリックし、"名前を変更"をクリックしてファイル名を"master.bmp"に変更する。
   <img src="picture/037.png" width="500">

5. それ以外の画像は削除する。
   - 削除しなくても問題ないですが、PCのストレージが圧迫されるため、不要な画像の削除をおすすめします。


### ステップ4: 選択したマスター画像をもとに検査に必要なファイルを生成
このステップは、マスター追加のステップ4と基本的に同様の手順です。マスター画像をもとに、検査に必要なファイル（master.npy/master_hue.txt）を生成します。

1. デスクトップの"マスター特徴量生成アプリ"を開く。
   <img src="picture/027.png" width="500">

2. 対象品種を選択して"特徴量生成開始"をクリック。（今回の例では"NKR"を選択。）
   <img src="picture/039.png" width="500">

3. "NKR"フォルダに、マスター画像(master.bmp)をベースとしたmaster.npyとmaster_hue.txtが生成される。

   <img src="picture/042.png" width="500">

4. 処理完了通知を"OK"を押して閉じ、"終了"ボタンを押してアプリを終了する。
   <img src="picture/040.png" width="500">


### ステップ5: 検査アプリで対象品種が検査できることを確認＆閾値設定
ステップ4までで、マスターの更新作業は完了しているので、実際に検査アプリを起動して、対象品種の検査を行ってみましょう。

（マスター追加の場合と同様の手順のため省略）
